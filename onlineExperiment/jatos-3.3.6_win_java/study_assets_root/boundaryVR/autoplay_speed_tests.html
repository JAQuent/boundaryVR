<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Spatial Experiment</title>
  <script src = "/study_assets_root/boundaryVR/jquery-3.3.1.min.js" type="text/javascript"></script>
  <script src="/assets/javascripts/jatos.js"></script>
  <script type="text/javascript" src="/study_assets_root/boundaryVR/autoplayDetector.js"></script>
</head>
<body>
  <div id="container" align="center" style="display: flex; flex-direction: column; margin: auto; flex: 1 1 100%; width: 90%; height: 90%;">
         <div id="display_message" style="font-family: 'Open Sans', 'Arial', sans-serif; font-size: 150%; line-height: 1.2em;"><br><br><br>Running browser tests, please wait...</div>
  </div>
</body>
<script>

	/* info about image used to test connection speed */
	var imageAddr = "/study_assets_root/boundaryVR/speed_test.jpg"; 
  var downloadSize = 2034200; //bytes, not accurate

  jatos.onLoad(function() {

      var curr_browser = getBrowser();

      /* Variables to hold information regarding the browser and speed, so a proper message can be displayed later */
      var speed;
      var result_data = {};
      jatos.addJatosIds(result_data);


      testSpeed(function(speed) {

        result_data.speed = speed;

        if (speed<5) {

          $("#display_message").html("<p><br><br><br>It looks like your current download speed is less than 5Mbps, which is the minimum needed to run the experiment.<br><br>Please mark the experiment as incomplete and we'll pay you for your time.</p>"); 
          result_data.test_status = "fail";
          result_data.fail_reason = "speed";
          result_json = JSON.stringify(result_data);
          var err_msg = 'SPEED';
          if ("prolific_ID" in jatos.studySessionData) {
              err_msg = err_msg + '_' + jatos.studySessionData.prolific_ID;
          }
          jatos.submitResultData(result_json, function() {return jatos.endStudyAjax(false,err_msg);});
        }

        /* If this is Edge or IE11 - no need to run the autodetect */
        if (curr_browser!='IE' && curr_browser != 'edge') {
          AutoplayDetector.isAutoplaySupported(function(autoplayResult) {
            result_data.autoplay = autoplayResult.autoplay;
            if (!autoplayResult.autoplay) {
              $("#display_message").html("<p style='text-align: justify;'><br><br><br>It looks like your browser doesn&#39;t currently support autoplay" +
                  " of movies, which is needed for the experiment to run properly. Please try again on a different browser, or adjust your browser&#39;s settings and refresh the page. To enable" +
                  " autoplay:<br>- In Firefox: enter about:config in the address bar and double-click on media.autoplay.enabled to set it to true<br>- In Chrome: enter chrome://flags/" +
                  " in the address bar, enter autoplay in the search box at the top and set 'Autoplay Policy' to be 'Default'. Click 'Relaunch now' to restart the browser with the new " +
                  "settings, then reload the page.<br><br>Please mark the experiment as incomplete and we'll pay you for your time.</p>"); 
              result_data.test_status = "fail";
              result_data.fail_reason = "autoplay";
              result_json = JSON.stringify(result_data);
              var err_msg = 'AUTOPLAY';
              if ("prolific_ID" in jatos.studySessionData) {
                  err_msg = err_msg + '_' + jatos.studySessionData.prolific_ID;
              }
              jatos.submitResultData(result_json, function() {return jatos.endStudyAjax(false,err_msg);});
            } else {
              result_json = "[" + JSON.stringify(result_data) + "]";
              jatos.submitResultData(result_json, jatos.startNextComponent);
            }
          }, 400);
        } else {
          result_json = "[" + JSON.stringify(result_data) + "]";
          jatos.submitResultData(result_json, jatos.startNextComponent);
        }
      });
    });
      
  function getBrowser () {
    // Opera 8.0+
    if((!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0) {
      return 'opera';
    }
    if (typeof InstallTrigger !== 'undefined'){
      return 'firefox';
    }

    if(/constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && safari.pushNotification))) {
      return 'safari';
    }

    if(/*@cc_on!@*/false || !!document.documentMode) {
      var isIE = true;
      return 'IE';
    }

    if(!isIE && !!window.StyleMedia) {
      return 'edge';
    }

    if(!!window.chrome && !!window.chrome.webstore) {
      return 'chrome';
    }
  }

  function testSpeed(callback_func) {

        if (window.addEventListener) {
            window.addEventListener('load', InitiateSpeedDetection(callback_func), false);
        } else if (window.attachEvent) {
            window.attachEvent('onload', InitiateSpeedDetection(callback_func));
        }

    }

    function InitiateSpeedDetection(callback_func) {
        window.setTimeout(function() {
            var startTime, endTime;
            var download = new Image();
            download.onload = function () {
                endTime = (new Date()).getTime();
                var duration = (endTime - startTime) / 1000;
                var bitsLoaded = downloadSize * 8;
                var speedBps = (bitsLoaded / duration).toFixed(2);
                var speedKbps = (speedBps / 1024).toFixed(2);
                var speedMbps = (speedKbps / 1024).toFixed(2);
                callback_func(speedMbps);
            }
        
            startTime = (new Date()).getTime();
            var cacheBuster = "?nnn=" + startTime;
            download.src = imageAddr + cacheBuster;
        }, 1);
    }
  
</script>
